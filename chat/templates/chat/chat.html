{% extends 'chat/base.html' %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{% url 'dashboard' %}">Django Chat</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
        <li class="nav-item">
          <a class="nav-link btn btn-sm btn-danger text-white ms-2" href="{% url 'logout' %}">Logout</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<style>
  body {
    background: #f7fafc;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .chat-container {
    max-width: 900px;
    margin: 1.5rem auto 3rem;
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    height: 80vh;
    overflow: hidden;
  }

  .chat-header {
    padding: 1rem 1.5rem;
    background-color: #4f46e5;
    color: #fff;
    font-weight: 700;
    font-size: 1.5rem;
    border-top-left-radius: 1rem;
    border-top-right-radius: 1rem;
  }

  #chat-box {
    flex-grow: 1;
    padding: 1rem 1.5rem;
    overflow-y: auto;
    border-bottom: 1px solid #e2e8f0;
  }

  .message {
    margin-bottom: 0.8rem;
    max-width: 70%;
    word-wrap: break-word;
  }

  .message.you {
    align-self: flex-end;
    background-color: #e0e7ff;
    border-radius: 15px 15px 0 15px;
    padding: 0.6rem 1rem;
    color: #1e293b;
  }

  .message.other {
    align-self: flex-start;
    background-color: #f1f5f9;
    border-radius: 15px 15px 15px 0;
    padding: 0.6rem 1rem;
    color: #334155;
  }

  .message small {
    display: block;
    margin-top: 0.25rem;
    color: #64748b;
    font-size: 0.75rem;
  }

  .attachment-link {
    margin-top: 0.3rem;
    display: inline-block;
    font-size: 0.9rem;
    color: #2563eb;
    text-decoration: none;
  }

  .attachment-link:hover {
    text-decoration: underline;
  }

  .chat-inputs {
    padding: 1rem 1.5rem;
    background: #f1f5f9;
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    border-bottom-left-radius: 1rem;
    border-bottom-right-radius: 1rem;
  }

  #messageInput {
    flex-grow: 1;
    padding: 0.6rem 1rem;
    font-size: 1rem;
    border-radius: 1.2rem;
    border: 1px solid #ccc;
    outline: none;
    transition: border-color 0.3s ease;
  }

  #messageInput:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 8px rgba(79, 70, 229, 0.4);
  }

  #sendButton {
    background-color: #4f46e5;
    border: none;
    color: white;
    padding: 0 1.4rem;
    border-radius: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #sendButton:hover {
    background-color: #4338ca;
  }

  #mediaInput {
    border-radius: 1.2rem;
    border: 1px solid #ccc;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    flex-basis: 200px;
  }

  #mediaUploadButton {
    background-color: #10b981;
    border: none;
    color: white;
    padding: 0 1.4rem;
    border-radius: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #mediaUploadButton:hover {
    background-color: #059669;
  }

  @media (max-width: 576px) {
    .chat-container {
      height: 90vh;
      border-radius: 0;
      margin: 0;
    }
    .chat-inputs {
      flex-direction: column;
    }
    #mediaInput {
      flex-basis: 100%;
    }
  }
</style>

<div class="chat-container">
  <div class="chat-header">
    Chat with {{ other_user.username }}
  </div>

  <div id="chat-box" aria-live="polite" aria-label="Chat messages" role="log">
    {% for msg in messages %}
      <div class="message {% if msg.sender.username == request.user.username %}you{% else %}other{% endif %}" data-msg-id="{{ msg.id }}">
        <strong>{% if msg.sender.username == request.user.username %}You{% else %}{{ msg.sender.username }}{% endif %}</strong>:

        <span class="msg-text">
          {% if msg.is_deleted %}
            <em class="text-muted">[message deleted]</em>
          {% else %}
            {{ msg.content }}
          {% endif %}
        </span>

        {% if msg.media and not msg.is_deleted %}
          <a href="{{ msg.media.url }}" target="_blank" class="attachment-link">ðŸ“Ž View Attachment</a>
        {% endif %}

        <small>{{ msg.formatted_time }}</small>

        {% if msg.sender.username == request.user.username and not msg.is_deleted %}
          <button class="btn btn-sm btn-danger delete-btn" data-msg-id="{{ msg.id }}">Delete</button>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <form id="messageForm" class="chat-inputs" autocomplete="off">
    <input type="text" id="messageInput" placeholder="Type a message..." required autocomplete="off">
    <button id="sendButton" type="submit" aria-label="Send message">Send</button>
  </form>

  <form id="mediaUploadForm" class="chat-inputs" enctype="multipart/form-data" autocomplete="off">
    <input type="file" id="mediaInput" accept="image/*,video/*,application/pdf" aria-label="Upload file to send">
    <button id="mediaUploadButton" type="submit" aria-label="Send file">ðŸ“Ž Send File</button>
  </form>
</div>

<script>
const currentUser = "{{ request.user.username }}";
const chatSocket = new WebSocket(
    (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
    window.location.host +
    '/ws/chat/private/{{ other_user.username|escapejs }}/'
);

const chatBox = document.getElementById('chat-box');

// Receive messages
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    // Handle delete event
    if (data.action === "delete_message") {
        const msgEl = document.querySelector(`[data-msg-id="${data.message_id}"]`);
        if (msgEl) {
            msgEl.querySelector(".msg-text").innerHTML = '<em class="text-muted">[message deleted]</em>';
            const attachment = msgEl.querySelector(".attachment-link");
            if (attachment) attachment.remove();
            const delBtn = msgEl.querySelector(".delete-btn");
            if (delBtn) delBtn.remove();
        }
        return;
    }

    if (!data.sender || (!data.message && !data.media_url)) {
        console.error("Invalid WebSocket data:", data);
        return;
    }

    const senderName = (data.sender === currentUser) ? "You" : data.sender;
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message ' + (data.sender === currentUser ? 'you' : 'other');
    msgDiv.dataset.msgId = data.message_id || '';

    let messageHtml = `<strong>${senderName}</strong>: <span class="msg-text">${data.message || ''}</span>`;
    if (data.media_url) {
        messageHtml += `<div><a href="${data.media_url}" target="_blank" class="attachment-link">ðŸ“Ž View Attachment</a></div>`;
    }
    messageHtml += `<small>${data.timestamp}</small>`;

    if (data.sender === currentUser && data.message_id) {
        messageHtml += ` <button class="btn btn-sm btn-danger delete-btn" data-msg-id="${data.message_id}">Delete</button>`;
    }

    msgDiv.innerHTML = messageHtml;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
};

// Send text message
document.getElementById('messageForm').onsubmit = function(e) {
    e.preventDefault();
    const message = document.getElementById('messageInput').value.trim();
    if (message) {
        chatSocket.send(JSON.stringify({
            'message': message,
            'media_url': ''
        }));
        document.getElementById('messageInput').value = '';
    }
};

// Send media
document.getElementById('mediaUploadForm').onsubmit = function(e) {
    e.preventDefault();
    const file = document.getElementById('mediaInput').files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
        chatSocket.send(JSON.stringify({
            'message': '',
            'media_url': event.target.result
        }));
    };
    reader.readAsDataURL(file);
    document.getElementById('mediaInput').value = '';
};

// Delete button click
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("delete-btn")) {
        const msgId = e.target.dataset.msgId;

        fetch(`/delete-message/${msgId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
            }
        })
        .then(res => res.json())
        .then(data => {
            if (!data.ok) {
                alert(data.error || "Failed to delete message");
            }
        })
        .catch(err => console.error(err));
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
